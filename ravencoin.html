<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembayaran Ravencoin</title>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 500px;
            margin: 20px auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        
        .header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .back-btn {
            color: #333;
            text-decoration: none;
            display: flex;
            align-items: center;
            margin-right: 10px;
            font-weight: 500;
        }
        
        h1 {
            text-align: center;
            margin: 0 auto;
            color: #333;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            background-color: #384186;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #2E3671;
        }
        
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-success {
            background-color: #28a745;
        }

        .btn-success:hover {
            background-color: #218838;
        }
        
        .payment-container {
            display: none;
            text-align: center;
        }
        
        .ravencoin-image {
            max-width: 100%;
            height: auto;
            margin: 20px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        
        .order-details {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .timer {
            font-size: 24px;
            font-weight: 700;
            color: #e74c3c;
            margin: 10px 0;
        }
        
        .status-message {
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            text-align: center;
            font-weight: 600;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .warning {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #384186;
            color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s, transform 0.3s;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .queue-info {
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .queue-info p {
            margin: 5px 0;
        }
        
        .queue-timer {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .steps-container {
            background-color: #f0f8ff;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .step-circle {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            background-color: #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        
        .step-circle.complete {
            background-color: #28a745;
        }

        .step-circle.active {
            background-color: #384186;
        }

        .step-circle.processing {
            background-color: #ffc107;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        .step-text {
            font-size: 14px;
        }

        .step-detail {
            font-size: 12px;
            color: #6c757d;
            margin-left: 30px;
            margin-top: 5px;
        }

        .step-waiting {
            font-size: 12px;
            color: #856404;
            margin-left: 30px;
            display: none;
        }
        
        .wallet-address {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
            position: relative;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #384186;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
        }

        .copy-btn:hover {
            background: #2E3671;
        }
        
        .transaction-details {
            margin-top: 15px;
            font-size: 14px;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
        }
        
        .transaction-id {
            word-break: break-all;
            background-color: #fff;
            padding: 5px;
            border-radius: 3px;
            font-family: monospace;
        }

        .user-info {
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .user-info p {
            margin: 5px 0;
        }
        
        .ravencoin-logo {
            width: 80px;
            height: 80px;
            display: block;
            margin: 0 auto 15px;
        }

        .payment-action {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .verification-progress {
            margin-top: 20px;
            display: none;
        }

        .verification-step {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .step-indicator {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #ccc;
            margin-right: 10px;
            text-align: center;
            line-height: 24px;
            font-weight: bold;
            color: white;
        }

        .step-indicator.active {
            background-color: #384186;
        }

        .step-indicator.complete {
            background-color: #28a745;
        }

        .pending-animation {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ffc107;
            margin-left: 10px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0% { opacity: 0.2; }
            50% { opacity: 1; }
            100% { opacity: 0.2; }
        }

        .payment-instructions {
            margin-bottom: 20px;
            font-size: 14px;
            text-align: left;
        }

        .payment-instructions ol {
            padding-left: 20px;
        }

        .payment-instructions li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-btn">
                ← Kembali
            </a>
            <h1>Pembayaran Ravencoin</h1>
        </div>
        
        <!-- Queue Info -->
        <div id="queueInfo" class="queue-info" style="display: none;">
            <p><strong>Status:</strong> Sedang ada pembayaran berlangsung</p>
            <p><strong>Berakhir dalam:</strong> <span id="queueTimer" class="queue-timer">00:00</span></p>
            <p>Mohon tunggu hingga pembayaran selesai atau waktu habis.</p>
        </div>
        
        <!-- User Info (will be populated from token) -->
        <div id="userInfo" class="user-info">
            <p><strong>Status:</strong> Mengambil informasi pengguna...</p>
        </div>
        
        <!-- Order Form -->
        <div id="orderForm">
            <img class="ravencoin-logo" src="https://cryptologos.cc/logos/ravencoin-rvn-logo.png" alt="Ravencoin Logo">
            <p style="text-align: center; margin-bottom: 20px;">Kirim Ravencoin (RVN) untuk melakukan pembayaran</p>
            <button id="submitBtn" class="btn" onclick="createOrder()">Buat Pembayaran</button>
            
            <div id="queueMessage" class="status-message warning" style="display: none;">
                Sedang ada pembayaran berlangsung. Mohon tunggu...
            </div>
        </div>
        
        <!-- Payment Container -->
        <div id="paymentContainer" class="payment-container">
            <div class="order-details">
                <p><strong>Order ID:</strong> <span id="orderId"></span></p>
                <p><strong>Nama:</strong> <span id="customerName"></span></p>
                <p><strong>No. HP:</strong> <span id="customerPhone"></span></p>
                <p><strong>NPM:</strong> <span id="customerNPM"></span></p>
            </div>
            
            <div class="timer">
                <span id="countdown">900</span> detik
            </div>

            <div class="payment-instructions">
                <h3>Petunjuk Pembayaran:</h3>
                <ol>
                    <li>Buka wallet Ravencoin Anda</li>
                    <li>Kirim RVN ke alamat wallet di bawah ini</li>
                    <li>Setelah mengirim, klik tombol "Saya Sudah Bayar"</li>
                    <li>Tunggu sistem memverifikasi pembayaran Anda</li>
                </ol>
            </div>
            
            <div class="wallet-address">
                <p><strong>Alamat Wallet Ravencoin:</strong></p>
                <p id="walletAddress"></p>
                <button class="copy-btn" onclick="copyWalletAddress()">Salin</button>
            </div>
            
            <img id="ravencoinQR" class="ravencoin-image" src="ravencoin.png" alt="Ravencoin QR Code">
            
            <!-- Payment Confirmation -->
            <div id="paymentAction" class="payment-action">
                <p>Setelah mengirim payment, klik tombol di bawah ini:</p>
                <button id="paymentConfirmBtn" class="btn btn-success" onclick="confirmPayment()">
                    Saya Sudah Bayar
                </button>
            </div>
            
            <!-- Verification Progress -->
            <div id="verificationProgress" class="verification-progress">
                <h3>Status Verifikasi Pembayaran:</h3>
                
                <div class="verification-step">
                    <div id="step1Indicator" class="step-indicator">1</div>
                    <div>
                        <div class="step-text">Mencari transaksi</div>
                        <div id="step1Status" class="step-detail">Mencari transaksi Anda di blockchain...</div>
                    </div>
                </div>
                
                <div class="verification-step">
                    <div id="step2Indicator" class="step-indicator">2</div>
                    <div>
                        <div class="step-text">Verifikasi detail transaksi</div>
                        <div id="step2Status" class="step-detail">Menunggu transaksi ditemukan...</div>
                    </div>
                </div>
                
                <div class="verification-step">
                    <div id="step3Indicator" class="step-indicator">3</div>
                    <div>
                        <div class="step-text">Konfirmasi blockchain</div>
                        <div id="step3Status" class="step-detail">Menunggu transaksi terverifikasi...</div>
                    </div>
                </div>
                
                <div id="transactionDetails" class="transaction-details" style="display: none;">
                    <p><strong>Transaction ID:</strong></p>
                    <p id="transactionId" class="transaction-id"></p>
                    <p><strong>Amount:</strong> <span id="transactionAmount">0</span> RVN</p>
                    <div id="confirmationWaiting" style="display: none;">
                        <p>Menunggu konfirmasi blockchain <span id="confirmationTime">20:00</span></p>
                    </div>
                </div>
            </div>
            
            <p class="status-message info">
                Pembayaran akan otomatis kedaluwarsa jika tidak diselesaikan dalam waktu yang ditentukan
            </p>
        </div>
        
        <!-- Status Container -->
        <div id="statusContainer" style="display: none; margin-top: 20px;">
            <div id="paymentStatus" class="status-message"></div>
            <div id="successDetails" style="display: none; margin-top: 15px;" class="order-details">
                <h3>Detail Transaksi:</h3>
                <p><strong>Transaction ID:</strong> <span id="successTxId" class="transaction-id"></span></p>
                <p><strong>Amount:</strong> <span id="successAmount">0</span> RVN</p>
            </div>
            <button id="newPaymentBtn" class="btn" onclick="resetForm()" style="margin-top: 15px;">
                Buat Pembayaran Baru
            </button>
        </div>
    </div>
    
    <!-- Notification container -->
    <div id="notification" class="notification"></div>

    <script>
        let orderId = null;
        let countdownInterval = null;
        let confirmationTimerInterval = null;
        let queueTimerInterval = null;
        let userInfo = {
            name: "",
            phoneNumber: "",
            npm: ""
        };
        const API_URL = "https://asia-southeast2-awangga.cloudfunctions.net/domyid";
        
        // Payment verification state
        const verificationState = {
            step1Complete: false,
            step2Complete: false,
            step3Complete: false,
            txid: null,
            amount: 0
        };
        
        // Check queue status and get user info when page loads
        document.addEventListener('DOMContentLoaded', function() {
            getUserInfo();
            checkQueueStatus();
        });
        
        // Get user info from token
        function getUserInfo() {
            fetch(`${API_URL}/api/crowdfunding/userinfo`, {
                method: 'GET',
                headers: {
                    'login': getCookie("login")  // Use 'login' not 'Authorization'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Display user info
                userInfo = {
                    name: data.name || "N/A",
                    phoneNumber: data.phoneNumber || "N/A",
                    npm: data.npm || "N/A"
                };
                
                // Update UI with user info
                const userInfoElement = document.getElementById('userInfo');
                userInfoElement.innerHTML = `
                    <p><strong>Nama:</strong> ${userInfo.name}</p>
                    <p><strong>No. HP:</strong> ${userInfo.phoneNumber}</p>
                    <p><strong>NPM:</strong> ${userInfo.npm}</p>
                `;
            })
            .catch(error => {
                console.error('Error getting user info:', error);
                showNotification('Gagal mengambil informasi pengguna. Silakan refresh halaman.');
            });
        }
        
        // Helper function to get cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return "";
        }
        
        // Format time from seconds to MM:SS
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        // Show notification function
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(function() {
                notification.classList.remove('show');
            }, 5000);
        }

        // Copy wallet address to clipboard
        function copyWalletAddress() {
            const walletAddress = document.getElementById('walletAddress').textContent;
            navigator.clipboard.writeText(walletAddress).then(() => {
                showNotification('Alamat wallet berhasil disalin!');
            }).catch(err => {
                console.error('Error copying text: ', err);
                showNotification('Gagal menyalin alamat. Silakan salin manual.');
            });
        }
        
        // Check queue status function
        function checkQueueStatus() {
            fetch(`${API_URL}/api/crowdfunding/queueStatus`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.isProcessing) {
                        // If there's an active payment, show queue info and disable form
                        document.getElementById('queueInfo').style.display = 'block';
                        document.getElementById('queueMessage').style.display = 'block';
                        document.getElementById('submitBtn').disabled = true;
                        
                        // Start queue countdown
                        if (data.expiryTime) {
                            startQueueTimer(data.expiryTime);
                        }
                        
                        // Check again after 5 seconds
                        setTimeout(checkQueueStatus, 5000);
                    } else {
                        // If no active payment, enable form
                        document.getElementById('queueInfo').style.display = 'none';
                        document.getElementById('queueMessage').style.display = 'none';
                        document.getElementById('submitBtn').disabled = false;
                        clearInterval(queueTimerInterval);
                    }
                })
                .catch(error => {
                    console.error('Error checking queue status:', error);
                    // Try again after a delay
                    setTimeout(checkQueueStatus, 10000);
                });
        }
        
        // Start queue timer
        function startQueueTimer(expiryTimeStr) {
            clearInterval(queueTimerInterval);
            
            const expiryTime = new Date(expiryTimeStr);
            const queueTimerElement = document.getElementById('queueTimer');
            
            queueTimerInterval = setInterval(function() {
                const now = new Date();
                const timeLeft = Math.max(0, Math.floor((expiryTime - now) / 1000));
                
                if (timeLeft <= 0) {
                    clearInterval(queueTimerInterval);
                    checkQueueStatus(); // Check queue status again when timer expires
                } else {
                    queueTimerElement.textContent = formatTime(timeLeft);
                }
            }, 1000);
        }
        
        // Create order function
        function createOrder() {
            // Show loading state
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="loading"></div> Memproses...';
            
            // Send request to server
            fetch(`${API_URL}/api/crowdfunding/ravencoin/createOrder`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'login': getCookie("login")  // Use 'login' not 'Authorization'
                },
                body: JSON.stringify({})
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Reset loading state
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Buat Pembayaran';
                
                if (data.success) {
                    // Save order ID
                    orderId = data.orderId;
                    
                    // Update payment details
                    document.getElementById('orderId').textContent = data.orderId;
                    document.getElementById('customerName').textContent = userInfo.name;
                    document.getElementById('customerPhone').textContent = userInfo.phoneNumber;
                    document.getElementById('customerNPM').textContent = userInfo.npm;
                    document.getElementById('walletAddress').textContent = data.walletAddress;
                    
                    // Show payment container and hide order form
                    document.getElementById('orderForm').style.display = 'none';
                    document.getElementById('userInfo').style.display = 'none';
                    document.getElementById('paymentContainer').style.display = 'block';
                    
                    // Start countdown - 15 minutes
                    startCountdown();
                    
                } else if (data.queueStatus) {
                    // If there's an active payment in queue
                    document.getElementById('queueMessage').style.display = 'block';
                    document.getElementById('queueInfo').style.display = 'block';
                    submitBtn.disabled = true;
                    
                    if (data.expiryTime) {
                        startQueueTimer(data.expiryTime);
                    }
                    
                    setTimeout(checkQueueStatus, 5000);
                    showNotification('Sedang ada pembayaran berlangsung. Mohon tunggu.');
                } else {
                    // Show error message
                    showNotification('Gagal membuat pembayaran: ' + (data.message || 'Silakan coba lagi.'));
                }
            })
            .catch(error => {
                console.error('Error creating order:', error);
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Buat Pembayaran';
                showNotification('Terjadi kesalahan. Silakan coba lagi.');
            });
        }
        
        // Start countdown function - 15 minutes (900 seconds)
        function startCountdown() {
            let timeLeft = 900; // 15 minutes
            const countdownElement = document.getElementById('countdown');
            countdownElement.textContent = timeLeft;
            
            countdownInterval = setInterval(function() {
                timeLeft--;
                countdownElement.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    // Show expired payment message
                    displayPaymentStatus('failed', 'Pembayaran kedaluwarsa. Silakan coba lagi.');
                }
            }, 1000);
        }
        
        // Confirm payment function
        function confirmPayment() {
            // Hide payment action button and show verification progress
            document.getElementById('paymentAction').style.display = 'none';
            document.getElementById('verificationProgress').style.display = 'block';
            
            // Set step 1 as active
            document.getElementById('step1Indicator').classList.add('active');
            document.getElementById('step1Status').innerHTML = 'Mencari transaksi Anda di blockchain... <span class="pending-animation"></span>';
            
            // Start the verification process
            checkForTransaction();
        }
        
        // Check for transaction function
        function checkForTransaction() {
            // Make request to check payment
            fetch(`${API_URL}/api/crowdfunding/checkPayment/${orderId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // If payment already succeeded (somehow)
                    if (data.status === 'success') {
                        completeAllSteps(data.txid, data.amount);
                        return;
                    }
                    
                    // If step 1 is complete (transaction found in mempool)
                    if (data.step1Complete) {
                        completeStep1(data.txid);
                        
                        // If step 2 is also complete
                        if (data.step2Complete) {
                            completeStep2(data.amount);
                        } else {
                            // Check if transaction details can be found
                            checkTransactionDetails(data.txid);
                        }
                    } else {
                        // No transaction found yet, try again after 5 seconds
                        setTimeout(checkForTransaction, 5000);
                    }
                })
                .catch(error => {
                    console.error('Error checking payment:', error);
                    // Try again after a delay
                    setTimeout(checkForTransaction, 10000);
                });
        }
        
        // Complete step 1 (transaction found)
        function completeStep1(txid) {
            if (verificationState.step1Complete) return; // Already completed
            
            verificationState.step1Complete = true;
            verificationState.txid = txid;
            
            // Update UI
            document.getElementById('step1Indicator').classList.remove('active');
            document.getElementById('step1Indicator').classList.add('complete');
            document.getElementById('step1Status').innerHTML = 'Transaksi ditemukan!';
            
            // Set step 2 as active
            document.getElementById('step2Indicator').classList.add('active');
            document.getElementById('step2Status').innerHTML = 'Memeriksa detail transaksi... <span class="pending-animation"></span>';
            
            // Show transaction ID
            document.getElementById('transactionId').textContent = txid;
            document.getElementById('transactionDetails').style.display = 'block';
        }
        
        // Check transaction details
        function checkTransactionDetails(txid) {
            // Call Step 2 endpoint to check transaction history
            fetch(`${API_URL}/api/crowdfunding/ravencoin/checkStep2/${orderId}?txid=${txid}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.step2Complete) {
                        // Transaction details verified
                        completeStep2(data.amount);
                    } else {
                        // Transaction details not found yet, try again after 5 seconds
                        setTimeout(() => checkTransactionDetails(txid), 5000);
                    }
                })
                .catch(error => {
                    console.error('Error checking transaction details:', error);
                    // Try again after a delay
                    setTimeout(() => checkTransactionDetails(txid), 10000);
                });
        }
        
        // Complete step 2 (transaction details verified)
        function completeStep2(amount) {
            if (verificationState.step2Complete) return; // Already completed
            
            verificationState.step2Complete = true;
            verificationState.amount = amount || 0;
            
            // Update UI
            document.getElementById('step2Indicator').classList.remove('active');
            document.getElementById('step2Indicator').classList.add('complete');
            document.getElementById('step2Status').innerHTML = 'Detail transaksi terverifikasi!';
            
            // Set step 3 as active
            document.getElementById('step3Indicator').classList.add('active');
            document.getElementById('step3Status').innerHTML = 'Menunggu konfirmasi blockchain... <span class="pending-animation"></span>';
            
            // Show amount if available
            if (amount) {
                document.getElementById('transactionAmount').textContent = amount.toFixed(8);
            }
            
            // Start the confirmation waiting period (20 minutes)
            startConfirmationTimer();
        }
        
        // Start confirmation timer (20 minutes)
        function startConfirmationTimer() {
            // Show the confirmation waiting section
            document.getElementById('confirmationWaiting').style.display = 'block';
            
            // Set 20 minute timer (1200 seconds)
            let timeLeft = 1200;
            const timerElement = document.getElementById('confirmationTime');
            timerElement.textContent = formatTime(timeLeft);
            
            confirmationTimerInterval = setInterval(function() {
                timeLeft--;
                timerElement.textContent = formatTime(timeLeft);
                
                if (timeLeft <= 0) {
                    clearInterval(confirmationTimerInterval);
                    // Once timer is done, finalize the transaction
                    finalizeTransaction();
                }
            }, 1000);
        }
        
        // Finalize transaction with the server
        function finalizeTransaction() {
            if (!verificationState.txid) return;
            
            // Call Step 3 endpoint to finalize the payment
            fetch(`${API_URL}/api/crowdfunding/ravencoin/checkStep3/${orderId}?txid=${verificationState.txid}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.step3Complete) {
                        // Payment completely successful
                        completeStep3(data.txid, data.amount);
                    } else {
                        // Something went wrong in the final verification
                        showNotification('Verifikasi final gagal: ' + (data.message || 'Silakan hubungi administrator.'));
                        
                        // Try again in 10 seconds
                        setTimeout(finalizeTransaction, 10000);
                    }
                })
                .catch(error => {
                    console.error('Error finalizing transaction:', error);
                    showNotification('Terjadi kesalahan saat finalisasi transaksi. Mencoba kembali...');
                    
                    // Try again after a delay
                    setTimeout(finalizeTransaction, 15000);
                });
        }
        
        // Complete step 3 (transaction fully confirmed)
        function completeStep3(txid, amount) {
            if (verificationState.step3Complete) return; // Already completed
            
            verificationState.step3Complete = true;
            
            // Update the amount if provided
            if (amount) {
                verificationState.amount = amount;
            }
            
            // Update UI
            document.getElementById('step3Indicator').classList.remove('active');
            document.getElementById('step3Indicator').classList.add('complete');
            document.getElementById('step3Status').innerHTML = 'Transaksi berhasil dikonfirmasi!';
            
            // Stop the countdown
            clearInterval(countdownInterval);
            
            // Display the successful payment status
            displayPaymentStatus('success', `Pembayaran berhasil! Jumlah: ${verificationState.amount.toFixed(8)} RVN`);
            
            // Show transaction details in success view
            document.getElementById('successTxId').textContent = txid || verificationState.txid;
            document.getElementById('successAmount').textContent = verificationState.amount.toFixed(8);
            document.getElementById('successDetails').style.display = 'block';
        }
        
        // Complete all steps at once (for when payment was already confirmed)
        function completeAllSteps(txid, amount) {
            completeStep1(txid);
            completeStep2(amount);
            completeStep3(txid, amount);
        }
        
        // Display payment status function
        function displayPaymentStatus(status, message) {
            // Stop all timers
            clearInterval(countdownInterval);
            clearInterval(confirmationTimerInterval);
            
            // Hide payment container
            document.getElementById('paymentContainer').style.display = 'none';
            
            // Update status message
            const statusElement = document.getElementById('paymentStatus');
            statusElement.textContent = message;
            
            if (status === 'success') {
                statusElement.className = 'status-message success';
            } else {
                statusElement.className = 'status-message error';
            }
            
            // Show status container
            document.getElementById('statusContainer').style.display = 'block';
        }
        
        // Reset form function
        function resetForm() {
            // Reset all state
            orderId = null;
            
            // Reset verification state
            verificationState.step1Complete = false;
            verificationState.step2Complete = false;
            verificationState.step3Complete = false;
            verificationState.txid = null;
            verificationState.amount = 0;
            
            // Clear all intervals
            clearInterval(countdownInterval);
            clearInterval(confirmationTimerInterval);
            
            // Reset UI
            document.getElementById('statusContainer').style.display = 'none';
            document.getElementById('paymentContainer').style.display = 'none';
            document.getElementById('orderForm').style.display = 'block';
            document.getElementById('userInfo').style.display = 'block';
            
            // Reset verification progress
            document.getElementById('verificationProgress').style.display = 'none';
            document.getElementById('step1Indicator').classList.remove('active', 'complete');
            document.getElementById('step2Indicator').classList.remove('active', 'complete');
            document.getElementById('step3Indicator').classList.remove('active', 'complete');
            document.getElementById('step1Status').innerHTML = 'Mencari transaksi Anda di blockchain...';
            document.getElementById('step2Status').innerHTML = 'Menunggu transaksi ditemukan...';
            document.getElementById('step3Status').innerHTML = 'Menunggu transaksi terverifikasi...';
            document.getElementById('transactionDetails').style.display = 'none';
            document.getElementById('confirmationWaiting').style.display = 'none';
            
            // Reset payment action
            document.getElementById('paymentAction').style.display = 'block';
            
            // Check queue status
            checkQueueStatus();
        }
    </script>
    <script type="module">
        import { getCookie } from "https://cdn.jsdelivr.net/gh/jscroot/cookie@0.0.1/croot.js";
        async function verifyLogin() {
            let token = getCookie("login");
            if (!token) {
                console.warn("❌ Token tidak ditemukan! Redirect ke halaman login..., lalu anda balik lagi ke https://do.my.id/crowdfunding");
                window.location.href = "https://do.my.id/signin";
                return;
            }
            console.log("✅ Token ditemukan:", token);
        }
        // Panggil fungsi saat halaman dimuat
        document.addEventListener("DOMContentLoaded", verifyLogin);
    </script>