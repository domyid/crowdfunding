<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembayaran Ravencoin - Sistem Baru</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .content {
            padding: 40px;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }
        
        .step-indicator::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            height: 2px;
            background: #e0e0e0;
            z-index: 1;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }
        
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #666;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .step-circle.active {
            background: #4CAF50;
            color: white;
        }
        
        .step-circle.processing {
            background: #FF9800;
            color: white;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .step-label {
            font-size: 0.9em;
            text-align: center;
            color: #666;
            max-width: 120px;
        }
        
        .payment-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .info-row:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 600;
            color: #333;
        }
        
        .info-value {
            color: #666;
            font-family: 'Courier New', monospace;
        }
        
        .wallet-address {
            background: #fff;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            word-break: break-all;
            text-align: center;
            margin: 10px 0;
        }
        
        .copy-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 10px;
            transition: background 0.3s ease;
        }
        
        .copy-btn:hover {
            background: #45a049;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        .btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .progress-details {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        
        .progress-step {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            background: white;
        }
        
        .progress-step:last-child {
            margin-bottom: 0;
        }
        
        .progress-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .progress-icon.pending {
            background: #ffc107;
            color: white;
        }
        
        .progress-icon.processing {
            background: #17a2b8;
            color: white;
            animation: spin 1s linear infinite;
        }
        
        .progress-icon.complete {
            background: #28a745;
            color: white;
        }
        
        .progress-icon.error {
            background: #dc3545;
            color: white;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-text {
            flex: 1;
        }
        
        .progress-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .progress-desc {
            font-size: 0.9em;
            color: #666;
        }
        
        .transaction-details {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .detail-row:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 600;
            color: #333;
        }
        
        .detail-value {
            color: #666;
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }
        
        .new-badge {
            background: #ff4757;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: bold;
            margin-left: 10px;
            animation: glow 2s infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 71, 87, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 71, 87, 0.8); }
        }

        .user-wallet-section {
            background: #e8f5e8;
            border: 1px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .user-wallet {
            font-family: 'Courier New', monospace;
            background: rgba(255,255,255,0.8);
            padding: 8px;
            border-radius: 4px;
            word-break: break-all;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💎 Pembayaran Ravencoin <span class="new-badge">NEW</span></h1>
            <p>Sistem Pembayaran Terbaru dengan Deteksi Real-time</p>
        </div>
        
        <div class="content">
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step">
                    <div class="step-circle" id="step1Circle">1</div>
                    <div class="step-label">Deteksi Transaksi</div>
                </div>
                <div class="step">
                    <div class="step-circle" id="step2Circle">2</div>
                    <div class="step-label">Konfirmasi Blockchain</div>
                </div>
                <div class="step">
                    <div class="step-circle" id="step3Circle">3</div>
                    <div class="step-label">Verifikasi Final</div>
                </div>
            </div>
            
            <!-- User Information -->
            <div id="userInfo" class="payment-info">
                <h3>👤 Memuat Data Pengguna...</h3>
                <p>Sedang mengambil informasi pengguna...</p>
            </div>

            <!-- Payment Information -->
            <div class="payment-info">
                <h3>📋 Informasi Pembayaran</h3>
                <div class="info-row">
                    <span class="info-label">Order ID:</span>
                    <span class="info-value" id="orderIdDisplay">-</span>
                </div>

                <!-- QR Code Section -->
                <div style="text-align: center; margin: 20px 0;">
                    <p><strong>Scan QR Code untuk pembayaran:</strong></p>
                    <img id="ravencoinQR" src="ravencoin.png" alt="Ravencoin QR Code" style="max-width: 200px; height: auto; border: 2px solid #4CAF50; border-radius: 10px; margin: 10px 0;">
                </div>

                <div class="info-row">
                    <span class="info-label">Alamat Wallet Tujuan:</span>
                    <div>
                        <div class="wallet-address" id="walletAddress">RKJpSmjTq5MPDaBx2ubTx1msVB2uZcKA5j</div>
                        <button class="copy-btn" onclick="copyWalletAddress()">📋 Copy</button>
                    </div>
                </div>
                <div class="info-row">
                    <span class="info-label">Status:</span>
                    <span class="info-value" id="paymentStatus">Menunggu pembayaran...</span>
                </div>
            </div>
            
            <!-- Order Form (Initial State) -->
            <div id="orderForm">
                <button class="btn" id="submitBtn" onclick="createOrder()">
                    🚀 Buat Pembayaran Ravencoin
                </button>

                <!-- Queue Message -->
                <div id="queueMessage" style="display: none;" class="status-message status-warning">
                    <h4>⏳ Sedang Ada Pembayaran Berlangsung</h4>
                    <p>Mohon tunggu hingga pembayaran sebelumnya selesai atau kedaluwarsa.</p>
                    <div id="queueInfo" style="display: none;">
                        <p><strong>Sisa waktu:</strong> <span id="queueTimer">-</span> detik</p>
                    </div>
                </div>
            </div>

            <!-- Payment Container (Hidden Initially) -->
            <div id="paymentContainer" style="display: none;">
                <div class="payment-info">
                    <h3>💰 Detail Pembayaran</h3>
                    <div class="info-row">
                        <span class="info-label">Order ID:</span>
                        <span class="info-value" id="orderId">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Nama:</span>
                        <span class="info-value" id="customerName">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">No. HP:</span>
                        <span class="info-value" id="customerPhone">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">NPM:</span>
                        <span class="info-value" id="customerNPM">-</span>
                    </div>
                </div>

                <!-- User Wallet Section -->
                <div id="userWalletSection" style="display: none;" class="user-wallet-section">
                    <p><strong>Your RVN Wallet:</strong></p>
                    <p id="userRVNWallet" class="user-wallet"></p>
                    <p style="font-size: 12px; color: #666;">Make sure to send payment from this wallet for better tracking.</p>
                </div>

                <p style="text-align: center; margin: 20px 0; font-weight: bold; color: #ff6b6b;">
                    JANGAN TINGGALKAN ATAU KELUAR DARI HALAMAN INI DAN JANGAN REFRESH JUGA !!!
                </p>

                <div class="timer" style="text-align: center; font-size: 1.5em; font-weight: bold; color: #ff6b6b; margin: 20px 0;">
                    <span id="countdown">1500</span> detik
                </div>

                <!-- QR Code and Wallet Address -->
                <div style="text-align: center; margin: 20px 0;">
                    <img id="ravencoinQR" src="ravencoin.png" alt="Ravencoin QR Code" style="max-width: 200px; height: auto; border: 2px solid #4CAF50; border-radius: 10px;">
                </div>

                <div class="wallet-address" style="text-align: center; margin: 20px 0;">
                    <p><strong>Alamat Wallet:</strong></p>
                    <p id="walletAddress" style="font-family: 'Courier New', monospace; word-break: break-all; background: #f8f9fa; padding: 10px; border-radius: 5px;">-</p>
                    <button class="copy-btn" onclick="copyWalletAddress()">📋 Copy Address</button>
                </div>
            </div>
            
            <!-- Status Messages -->
            <div id="statusMessages"></div>
            
            <!-- Progress Details -->
            <div class="progress-details" id="progressDetails">
                <h3>📊 Detail Progress</h3>
                <div class="progress-step" id="progressStep1">
                    <div class="progress-icon pending" id="progressIcon1">1</div>
                    <div class="progress-text">
                        <div class="progress-title">Step 1: Deteksi Transaksi</div>
                        <div class="progress-desc" id="progressDesc1">Mengecek apakah transaksi exists di blockchain...</div>
                    </div>
                </div>
                <div class="progress-step" id="progressStep2">
                    <div class="progress-icon pending" id="progressIcon2">2</div>
                    <div class="progress-text">
                        <div class="progress-title">Step 2: Konfirmasi Blockchain</div>
                        <div class="progress-desc" id="progressDesc2">Menunggu konfirmasi dari network...</div>
                    </div>
                </div>
                <div class="progress-step" id="progressStep3">
                    <div class="progress-icon pending" id="progressIcon3">3</div>
                    <div class="progress-text">
                        <div class="progress-title">Step 3: Verifikasi Final</div>
                        <div class="progress-desc" id="progressDesc3">Verifikasi amount dan finalisasi pembayaran...</div>
                    </div>
                </div>
            </div>
            
            <!-- Transaction Details -->
            <div class="transaction-details" id="transactionDetails">
                <h3>✅ Detail Transaksi</h3>
                <div class="detail-row">
                    <span class="detail-label">Transaction ID:</span>
                    <span class="detail-value" id="finalTxid">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Amount:</span>
                    <span class="detail-value" id="finalAmount">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Confirmations:</span>
                    <span class="detail-value" id="finalConfirmations">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value" id="finalStatus">-</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_URL = "https://asia-southeast2-awangga.cloudfunctions.net/domyid";
        const WALLET_ADDRESS = 'RKJpSmjTq5MPDaBx2ubTx1msVB2uZcKA5j';
        
        // State management (following ravencoin.html pattern)
        let orderId = null;
        let userInfo = {};
        let verificationState = {
            step1Complete: false,
            step2Complete: false,
            step3Complete: false,
            txid: null,
            amount: 0,
            confirmations: 0
        };

        // Intervals for monitoring
        let checkPaymentStatusInterval = null;
        let countdownInterval = null;
        let queueCheckInterval = null;

        // Initialize page (following ravencoin.html pattern)
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Page loaded, initializing...");
            setupRefreshWarning();
            getUserInfo();
            checkQueueStatus();
        });

        // Setup refresh warning (prevent accidental refresh during payment)
        function setupRefreshWarning() {
            window.paymentInProgress = false;

            window.addEventListener('beforeunload', function(e) {
                if (window.paymentInProgress) {
                    const confirmationMessage = 'Pembayaran sedang berlangsung. Yakin ingin meninggalkan halaman?';
                    e.returnValue = confirmationMessage;
                    return confirmationMessage;
                }
            });
        }

        // Check queue status (same as ravencoin.html)
        function checkQueueStatus() {
            console.log("Checking queue status...");

            fetch(`${API_URL}/api/crowdfunding/checkQueue`, {
                method: 'GET',
                headers: {
                    'login': getCookie("login")
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log("Queue status:", data);

                if (data.isProcessing) {
                    // Show queue message
                    const queueMessage = document.getElementById('queueMessage');
                    const queueInfo = document.getElementById('queueInfo');
                    const submitBtn = document.getElementById('submitBtn');

                    if (queueMessage) queueMessage.style.display = 'block';
                    if (queueInfo) queueInfo.style.display = 'block';
                    if (submitBtn) submitBtn.disabled = true;

                    if (data.expiryTime) {
                        startQueueTimer(data.expiryTime);
                    }

                    // Check again in 5 seconds
                    setTimeout(checkQueueStatus, 5000);
                } else {
                    // Queue is free, enable order creation
                    const queueMessage = document.getElementById('queueMessage');
                    const submitBtn = document.getElementById('submitBtn');

                    if (queueMessage) queueMessage.style.display = 'none';
                    if (submitBtn) submitBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error checking queue:', error);
                // On error, assume queue is free
                const submitBtn = document.getElementById('submitBtn');
                if (submitBtn) submitBtn.disabled = false;
            });
        }

        // Helper function to get cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return '';
        }
        
        // Get user info from token
        function getUserInfo() {
            console.log("Getting user info...");

            fetch(`${API_URL}/api/crowdfunding/userinfo`, {
                method: 'GET',
                headers: {
                    'login': getCookie("login")
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("User info received:", data);

                // Validate the data
                const validation = validateUserData(data);

                if (!validation.isValid) {
                    showUserDataError(validation);
                } else {
                    // Store user info globally
                    userInfo = data;
                    showUserDataSuccess(data);
                }
            })
            .catch(error => {
                console.error('Error getting user info:', error);
                showUserDataError({
                    isValid: false,
                    missingFields: ['Connection Error'],
                    issues: [error.message]
                });
            });
        }

        // Validate user data
        function validateUserData(data) {
            const validationResult = {
                isValid: true,
                missingFields: [],
                issues: []
            };

            // Check Name
            if (!data.name || data.name.trim() === "" || data.name === null || data.name === undefined) {
                validationResult.missingFields.push("Name");
                validationResult.isValid = false;
            }

            // Check Phone Number
            if (!data.phoneNumber || data.phoneNumber.trim() === "" || data.phoneNumber === null || data.phoneNumber === undefined) {
                validationResult.missingFields.push("Phone Number");
                validationResult.isValid = false;
            }

            // Check NPM
            if (!data.npm || data.npm.trim() === "" || data.npm === null || data.npm === undefined) {
                validationResult.missingFields.push("NPM");
                validationResult.isValid = false;
            }

            // Check RVN Wallet - strict validation
            if (!data.rvnwallet || data.rvnwallet === "N/A" || data.rvnwallet.trim() === "" || data.rvnwallet === null || data.rvnwallet === undefined) {
                validationResult.missingFields.push("RVN Wallet");
                validationResult.isValid = false;
            } else {
                // Additional validation for RVN wallet format
                const rvnWallet = data.rvnwallet.trim();
                if (!rvnWallet.startsWith('R') || rvnWallet.length !== 34) {
                    validationResult.missingFields.push("RVN Wallet (Format Invalid)");
                    validationResult.isValid = false;
                }
            }

            return validationResult;
        }

        // Show user data success
        function showUserDataSuccess(data) {
            const userInfoElement = document.getElementById('userInfo');
            if (userInfoElement) {
                userInfoElement.innerHTML = `
                    <div style="background-color: #d4edda; color: #155724; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #28a745;">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <span style="font-size: 24px; margin-right: 10px;">✅</span>
                            <h3 style="margin: 0; color: #155724;">Data Pengguna Lengkap</h3>
                        </div>
                        <div style="background-color: rgba(40, 167, 69, 0.1); padding: 15px; border-radius: 8px;">
                            <p style="margin: 8px 0;"><strong>Nama:</strong> ${data.name}</p>
                            <p style="margin: 8px 0;"><strong>No. HP:</strong> ${data.phoneNumber}</p>
                            <p style="margin: 8px 0;"><strong>NPM:</strong> ${data.npm}</p>
                            <p style="margin: 8px 0;"><strong>RVN Wallet:</strong> <span style="font-family: 'Courier New', monospace; background: rgba(255,255,255,0.7); padding: 2px 6px; border-radius: 4px;">${data.rvnwallet}</span></p>
                        </div>
                    </div>
                `;
            }

            // Enable submit button
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.style.opacity = '1';
                submitBtn.style.cursor = 'pointer';
            }
        }

        // Show user data error
        function showUserDataError(validation) {
            const userInfoElement = document.getElementById('userInfo');
            const rvnWalletMissing = validation.missingFields.includes("RVN Wallet") || validation.missingFields.includes("RVN Wallet (Format Invalid)");

            if (userInfoElement) {
                userInfoElement.innerHTML = `
                    <div style="background-color: #fff3cd; color: #856404; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #ffc107;">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <span style="font-size: 24px; margin-right: 10px;">⚠️</span>
                            <h3 style="margin: 0; color: #856404;">Data Pengguna Tidak Lengkap</h3>
                        </div>

                        <p><strong>Data yang harus dilengkapi:</strong></p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            ${validation.missingFields.map(field => `<li><strong>${field}</strong></li>`).join('')}
                        </ul>

                        ${rvnWalletMissing ? `
                            <div style="background-color: rgba(220, 53, 69, 0.1); padding: 10px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #dc3545;">
                                <p style="margin: 0; font-weight: bold; color: #dc3545;">🔑 RVN Wallet Wajib Diisi!</p>
                                <p style="margin: 5px 0 0 0; font-size: 14px;">Untuk pembayaran Ravencoin, alamat RVN Wallet adalah wajib dan tidak boleh kosong.</p>
                                <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">Format: Harus dimulai dengan 'R' dan panjang 34 karakter<br>Contoh: <code>RL2B5W4ABvFRLbnQsmE7SJUw9HKVd68gTH</code></p>
                            </div>
                        ` : ''}

                        <div style="background-color: rgba(255, 193, 7, 0.2); padding: 10px; border-radius: 5px; margin-top: 15px;">
                            <p style="margin: 0; font-weight: bold;">🔧 Cara Mengatasi:</p>
                            <ol style="margin: 10px 0; padding-left: 20px;">
                                <li>Klik tombol di bawah untuk ke halaman profil</li>
                                <li>Lengkapi semua data yang diminta (terutama RVN Wallet)</li>
                                <li>Simpan perubahan</li>
                                <li>Kembali ke halaman ini (refresh jika perlu)</li>
                            </ol>
                            <div style="text-align: center; margin-top: 15px;">
                                <a href="https://www.do.my.id/dashboard/#profile/accounts" target="_blank" style="display: inline-block; background-color: #ffc107; color: #000; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-weight: bold;">
                                    🔧 Lengkapi Data Profil
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Disable submit button
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.style.opacity = '0.5';
                submitBtn.style.cursor = 'not-allowed';
            }
        }
        

        
        function copyWalletAddress() {
            navigator.clipboard.writeText(WALLET_ADDRESS).then(() => {
                showMessage('Alamat wallet berhasil disalin!', 'success');
            }).catch(() => {
                showMessage('Gagal menyalin alamat wallet', 'error');
            });
        }
        
        // Create order function (following ravencoin.html pattern)
        function createOrder() {
            console.log("Creating order...");
            console.log("Current userInfo:", userInfo);

            // Double-check user data before creating order
            if (!userInfo.name || !userInfo.phoneNumber || !userInfo.npm || !userInfo.rvnwallet) {
                console.log("Order creation blocked - incomplete data");
                showMessage("Data pengguna tidak lengkap. Silakan refresh halaman dan lengkapi profil Anda.", 'error');
                return;
            }

            console.log("Order validation passed");

            // Show loading state
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<div style="display: inline-block; width: 16px; height: 16px; border: 2px solid #fff; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite;"></div> Memproses...';
            }

            // Send request to server
            fetch(`${API_URL}/api/crowdfunding/ravencoin/createOrder`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'login': getCookie("login")
                },
                body: JSON.stringify({})
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Order creation response:", data);

                // Reset loading state
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '🚀 Buat Pembayaran Ravencoin';
                }

                if (data.success) {
                    // Mark payment as in progress to prevent refresh
                    window.paymentInProgress = true;

                    // Save order ID
                    orderId = data.orderId;

                    // Update payment details
                    updatePaymentDetails(data);

                    // Show payment container and hide order form
                    showPaymentContainer();

                    // Reset verification state
                    resetVerificationState();

                    // Start countdown - 15 minutes
                    startCountdown();

                    console.log("Starting payment status checking");
                    // Start checking payment status immediately
                    checkPaymentStatus();

                    // Then set interval for continuous checking
                    checkPaymentStatusInterval = setInterval(checkPaymentStatus, 3000);

                } else if (data.queueStatus) {
                    // If there's an active payment in queue
                    handleQueueStatus(data);
                } else {
                    // Show error message
                    showMessage('Gagal membuat pembayaran: ' + data.message, 'error');
                    console.log("Payment creation failed:", data.message);
                }
            })
            .catch(error => {
                console.log("Error creating order:", error.message);
                console.error('Error creating order:', error);
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '🚀 Buat Pembayaran Ravencoin';
                }
                showMessage('Terjadi kesalahan. Silakan coba lagi.', 'error');
            });
        }
        
        // Update payment details (following ravencoin.html pattern)
        function updatePaymentDetails(data) {
            const orderIdEl = document.getElementById('orderId');
            const customerNameEl = document.getElementById('customerName');
            const customerPhoneEl = document.getElementById('customerPhone');
            const customerNPMEl = document.getElementById('customerNPM');
            const walletAddressEl = document.getElementById('walletAddress');

            if (orderIdEl) orderIdEl.textContent = data.orderId;
            if (customerNameEl) customerNameEl.textContent = userInfo.name;
            if (customerPhoneEl) customerPhoneEl.textContent = userInfo.phoneNumber;
            if (customerNPMEl) customerNPMEl.textContent = userInfo.npm;
            if (walletAddressEl) walletAddressEl.textContent = data.walletAddress;

            // Show user wallet if available
            if (userInfo.rvnwallet) {
                const userRVNWallet = document.getElementById('userRVNWallet');
                const userWalletSection = document.getElementById('userWalletSection');
                if (userRVNWallet) userRVNWallet.textContent = userInfo.rvnwallet;
                if (userWalletSection) userWalletSection.style.display = 'block';
            }
        }

        // Show payment container and hide order form
        function showPaymentContainer() {
            const orderForm = document.getElementById('orderForm');
            const userInfoEl = document.getElementById('userInfo');
            const paymentContainer = document.getElementById('paymentContainer');

            if (orderForm) orderForm.style.display = 'none';
            if (userInfoEl) userInfoEl.style.display = 'none';
            if (paymentContainer) paymentContainer.style.display = 'block';

            // Show progress details
            document.getElementById('progressDetails').style.display = 'block';
        }

        // Reset verification state
        function resetVerificationState() {
            verificationState.step1Complete = false;
            verificationState.step2Complete = false;
            verificationState.step3Complete = false;
            verificationState.txid = null;
            verificationState.amount = 0;

            // Reset UI elements
            const step1Circle = document.getElementById('step1Circle');
            const step2Circle = document.getElementById('step2Circle');
            const step3Circle = document.getElementById('step3Circle');

            if (step1Circle) step1Circle.className = 'step-circle';
            if (step2Circle) step2Circle.className = 'step-circle';
            if (step3Circle) step3Circle.className = 'step-circle';

            // Reset progress steps
            for (let i = 1; i <= 3; i++) {
                updateProgressStep(i, 'pending', getDefaultStepDescription(i));
            }

            // Hide transaction details
            const transactionDetails = document.getElementById('transactionDetails');
            if (transactionDetails) transactionDetails.style.display = 'none';
        }

        // Start countdown function - 15 minutes (1500 seconds)
        function startCountdown() {
            let timeLeft = 1500; // 15 minutes
            const countdownElement = document.getElementById('countdown');
            if (countdownElement) countdownElement.textContent = timeLeft;

            console.log("Starting payment countdown:", timeLeft, "seconds");

            countdownInterval = setInterval(function() {
                timeLeft--;
                if (countdownElement) countdownElement.textContent = timeLeft;

                if (timeLeft <= 0) {
                    console.log("Payment countdown expired");
                    clearInterval(countdownInterval);
                    clearInterval(checkPaymentStatusInterval);

                    // Payment is no longer in progress
                    window.paymentInProgress = false;

                    // Show expired payment message
                    showMessage('Pembayaran kedaluwarsa. Silakan coba lagi.', 'error');
                }
            }, 1000);
        }
        
        // Check payment status function - using NEW backend system
        function checkPaymentStatus() {
            if (!orderId) return;

            // If all verification steps are complete, clear interval and stop checking
            if (verificationState.step1Complete && verificationState.step2Complete && verificationState.step3Complete) {
                clearInterval(checkPaymentStatusInterval);
                return;
            }

            // If Step 1 is complete but Step 2 is not, check Step 2
            if (verificationState.step1Complete && !verificationState.step2Complete) {
                checkStep2();
                return;
            }

            // If Step 2 is complete but Step 3 is not, check Step 3
            if (verificationState.step2Complete && !verificationState.step3Complete) {
                checkStep3();
                return;
            }

            // Check Step 1 (initial transaction detection) - using original endpoint first
            console.log(`Checking payment status for order ${orderId} (Step 1)`);
            fetch(`${API_URL}/api/crowdfunding/checkPayment/${orderId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Payment status response:", data);

                    if (data.step1Complete && data.txid) {
                        // Step 1 complete - transaction detected
                        verificationState.step1Complete = true;
                        verificationState.txid = data.txid;
                        verificationState.amount = data.amount || 0;

                        updateProgressStep(1, 'complete', `Transaksi ditemukan! TXID: ${data.txid.substring(0, 16)}...`);
                        updateStepIndicator(1, 'active');

                        showMessage(`✅ Step 1 Complete: Transaksi ditemukan dengan TXID ${data.txid.substring(0, 16)}...`, 'success');

                        // Continue to Step 2
                        checkStep2();
                    } else {
                        // Still waiting for transaction
                        updateProgressStep(1, 'processing', 'Menunggu pembayaran Ravencoin...');
                        updateStepIndicator(1, 'processing');
                    }
                })
                .catch(error => {
                    console.error('Error checking payment status:', error);
                    updateProgressStep(1, 'error', 'Error: ' + error.message);
                });
        }

        function checkStep2() {
            if (!orderId || !verificationState.txid) return;

            updateProgressStep(2, 'processing', 'Mengecek konfirmasi blockchain...');
            updateStepIndicator(2, 'processing');

            console.log(`Checking Step 2 for order ${orderId} with txid ${verificationState.txid}`);

            // Use NEW backend system for Step 2
            fetch(`${API_URL}/api/crowdfunding/ravencoin/checkStep2New/${orderId}?txid=${verificationState.txid}`)
                .then(response => response.json())
                .then(data => {
                    console.log("Step 2 response:", data);

                    if (data.status === 'success' && data.step2Complete) {
                        // Step 2 complete
                        verificationState.step2Complete = true;
                        verificationState.confirmations = data.confirmations;

                        updateProgressStep(2, 'complete', `Transaksi dikonfirmasi! ${data.confirmations} confirmations`);
                        updateStepIndicator(2, 'active');

                        showMessage(`✅ Step 2 Complete: Transaksi dikonfirmasi dengan ${data.confirmations} confirmations`, 'success');

                        // Continue to Step 3
                        checkStep3();
                    } else {
                        // Step 2 pending
                        updateProgressStep(2, 'processing', `Menunggu konfirmasi... (${data.confirmations || 0} confirmations)`);
                        console.log(`Step 2 pending, confirmations: ${data.confirmations || 0}`);
                    }
                })
                .catch(error => {
                    console.error('Error in Step 2:', error);
                    updateProgressStep(2, 'error', 'Error: ' + error.message);
                });
        }

        function checkStep3() {
            if (!orderId || !verificationState.txid) return;

            updateProgressStep(3, 'processing', 'Verifikasi final dan finalisasi...');
            updateStepIndicator(3, 'processing');

            console.log(`Checking Step 3 for order ${orderId} with txid ${verificationState.txid}`);

            // Use existing Step 3 endpoint (this one is already working well)
            fetch(`${API_URL}/api/crowdfunding/ravencoin/checkStep3/${orderId}?txid=${verificationState.txid}`)
                .then(response => response.json())
                .then(data => {
                    console.log("Step 3 response:", data);

                    if (data.status === 'success' && data.step3Complete) {
                        // Step 3 complete - Payment successful!
                        verificationState.step3Complete = true;
                        verificationState.amount = data.amount || verificationState.amount;

                        updateProgressStep(3, 'complete', 'Pembayaran berhasil dikonfirmasi!');
                        updateStepIndicator(3, 'active');

                        // Clear intervals
                        clearInterval(checkPaymentStatusInterval);
                        clearInterval(countdownInterval);

                        // Payment is no longer in progress
                        window.paymentInProgress = false;

                        showMessage(`🎉 Pembayaran Berhasil! Amount: ${verificationState.amount.toFixed(8)} RVN`, 'success');

                        // Show transaction details
                        showTransactionDetails();

                        console.log("Payment completed successfully!");

                    } else {
                        // Step 3 pending
                        updateProgressStep(3, 'processing', 'Memverifikasi detail transaksi...');
                        console.log("Step 3 pending, continuing verification...");
                    }
                })
                .catch(error => {
                    console.error('Error in Step 3:', error);
                    updateProgressStep(3, 'error', 'Error: ' + error.message);
                });
        }

        function updateProgressStep(stepNum, status, description) {
            const icon = document.getElementById(`progressIcon${stepNum}`);
            const desc = document.getElementById(`progressDesc${stepNum}`);

            // Remove all status classes
            icon.className = 'progress-icon';

            // Add new status class
            icon.classList.add(status);

            // Update description
            desc.textContent = description;

            // Update icon content based on status
            if (status === 'complete') {
                icon.textContent = '✓';
            } else if (status === 'error') {
                icon.textContent = '✗';
            } else if (status === 'processing') {
                icon.textContent = '⟳';
            } else {
                icon.textContent = stepNum;
            }
        }

        function updateStepIndicator(stepNum, status) {
            const circle = document.getElementById(`step${stepNum}Circle`);

            // Remove all status classes
            circle.className = 'step-circle';

            // Add new status class
            if (status === 'active') {
                circle.classList.add('active');
            } else if (status === 'processing') {
                circle.classList.add('processing');
            }
        }

        function showMessage(message, type) {
            const container = document.getElementById('statusMessages');

            const messageDiv = document.createElement('div');
            messageDiv.className = `status-message status-${type}`;
            messageDiv.textContent = message;

            // Clear previous messages
            container.innerHTML = '';
            container.appendChild(messageDiv);

            // Auto-hide info messages after 5 seconds
            if (type === 'info') {
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 5000);
            }
        }

        function showTransactionDetails() {
            const finalTxid = document.getElementById('finalTxid');
            const finalAmount = document.getElementById('finalAmount');
            const finalConfirmations = document.getElementById('finalConfirmations');
            const finalStatus = document.getElementById('finalStatus');
            const transactionDetails = document.getElementById('transactionDetails');

            if (finalTxid) finalTxid.textContent = verificationState.txid;
            if (finalAmount) finalAmount.textContent = `${verificationState.amount.toFixed(8)} RVN`;
            if (finalConfirmations) finalConfirmations.textContent = verificationState.confirmations;
            if (finalStatus) finalStatus.textContent = 'Berhasil ✅';
            if (transactionDetails) transactionDetails.style.display = 'block';
        }

        // Copy wallet address function
        function copyWalletAddress() {
            const walletAddress = document.getElementById('walletAddress').textContent;
            navigator.clipboard.writeText(walletAddress).then(() => {
                showMessage('Alamat wallet berhasil disalin!', 'success');
            }).catch(() => {
                showMessage('Gagal menyalin alamat wallet', 'error');
            });
        }

        // Start queue timer
        function startQueueTimer(expiryTime) {
            const queueTimer = document.getElementById('queueTimer');
            if (!queueTimer) return;

            const updateTimer = () => {
                const now = new Date().getTime();
                const timeLeft = Math.max(0, Math.floor((expiryTime - now) / 1000));

                if (queueTimer) queueTimer.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(queueCheckInterval);
                    checkQueueStatus(); // Recheck queue status
                }
            };

            updateTimer();
            queueCheckInterval = setInterval(updateTimer, 1000);
        }

        // Handle queue status
        function handleQueueStatus(data) {
            const queueMessage = document.getElementById('queueMessage');
            const queueInfo = document.getElementById('queueInfo');
            const submitBtn = document.getElementById('submitBtn');

            if (queueMessage) queueMessage.style.display = 'block';
            if (queueInfo) queueInfo.style.display = 'block';
            if (submitBtn) submitBtn.disabled = true;

            if (data.expiryTime) {
                startQueueTimer(data.expiryTime);
            }

            // Check again in 5 seconds
            setTimeout(checkQueueStatus, 5000);
        }

        // Add CSS for spin animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);

        function getDefaultStepDescription(stepNum) {
            const descriptions = {
                1: 'Mengecek apakah transaksi exists di blockchain...',
                2: 'Menunggu konfirmasi dari network...',
                3: 'Verifikasi amount dan finalisasi pembayaran...'
            };
            return descriptions[stepNum] || '';
        }
    </script>
</body>
</html>
